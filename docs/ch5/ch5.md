## 事务处理（复习）

### ACID 事务

处理必须遵循的原则

- 原子性 *事务的本质要求*
- 一致性 *数据完整的本质要求，唯一一个可以由开发者控制而不是凭数据库自身保证的属性*
- 隔离性 *并发的本质要求*
- 持久性 *数据库系统的本质要求*

### 事务处理的组件

- 事务管理器
- 锁管理器
- 页缓存
- 日志管理器
- 分布式事务协调

## 缓冲区管理

### 不使用OS

为什么要自己实现缓存池，而不使用操作系统的$mmap$

- dirty pages事务性写回
- 预存数据
- 定制替换策略
- 线程/进程调度

DBMS告诉OS， 不要缓存这些数据 -> **Direct I/O**

### Buffer Pool Manager

DBMS维护一个页表`page table`, 记录page在内存中的位置、Dirty Flag、引用计数（使用该page的线程数）

页表本质是一个哈希表，通过**页表**和**page id**可以确定在哪一个frame中

### 替换策略

1. FIFO先进先出

2. LRU：Least Recently Used 最近最少使用算法 *时间戳最老*

   实现：维护一个队列，读写page放入队尾，队首page被换出

3. Clock时钟：LRU的近似算法

   > LRU算法和Clock时钟算法的问题：存在顺序洪水问题。当顺序扫描大量一次性的page时，非常常用的page可能会被换出。

4. LRU-K算法，最近使用过K次

   $K$是对单个page对应缓存数据的访问进行计数的次数

### 脏页

脏页被换出需要写回到磁盘

后台写：后台线程定期扫描page table， 将脏页写入磁盘，标记为干净