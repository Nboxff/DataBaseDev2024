## 什么是索引

数据库管理系统（DBMS）中一个排序的数据结构，以协助快速查询、更新数据表中的数据。

> 快速主要针对**读**
>
> 思考：应该用什么数据结构？

## 索引的数据结构—B+树

### 二分搜索树(BST)

我们从二分搜索树(BST)思考数据库索引应该使用的数据结构

![](image-20240311141114638.png)

当树的一侧“过长”，查找的时间复杂度会退化成$O(n)$，需要通过`旋转操作`使树达到平衡

![](image-20240311141357711.png)

旋转操作：

![](image-20240311141416547.png)

### 基于磁盘存储的树-磁盘

平台级软件，和硬件的关系非常⼤（操作系统、数据库、嵌⼊式、芯片……）

> **磁盘**的最小单元：page、**block**
>

图示：

![](image-20240311142921145.png)

在磁盘修改数据的两种方式：

- 将修改操作处理成删除和插入
- 行迁移操作：添加指针指向放不下的数据 *会导致数据读取效率下降(数据在不同块中)*

*在处理磁盘存储数据的结构需要考虑块读取的问题*

磁盘上的树要考虑磁盘读取效率，树主要考虑以下两个指标：

- 扇出(fanout)：每个节点允许最大的子节点
- 树高(tree height)：树的高度  *多少层的树，就要读取IO多少次*

**高扇出**（改善临近键的数据局限性）为手段实现**低树高**

### 基于磁盘存储的树-B-Tree(B+Tree)

> 在数据库领域，B树指这一类结构的树，其中也包含B+树
>
> B树是一块一块的将数据读取到内存，哪怕访问的是一条，也会把该条所在的块读入到内存，一般是4K一个块。

**B Tree (B+Tree)结构**

![](image-20240311143902833.png)

![](image-20240311150430592.png)

- 页组织技术，一个节点就是一个Page*（如4K, 16K）*
- 每个节点最多$N$个键和$N+1$个指向节点的指针
- 占用率：节点容量和实际持有键的数量之间的关系
  - 占用率高利于读，但不利于写

**B树和B+树之间的差异**：B+树中，非叶子节点只做比较，数据存储在叶子节点中。

叶节点的同级节点指针：解决SQL中范围查询`BETWEEN`的效率问题

### B树查找算法

- 查找，从根节点到叶节点的单向遍历

- 从根节点上执行⼆分搜索算法，将要搜索的$K$，与存储在根节点中的$K_n$进行

  比较，直到找到大于$K$的第⼀个分隔键，这样定位了⼀个要搜索的子树，顺

  着相应指针继续相同的搜索过程，直到目标叶节点，找到数据主文件指针

块中键数量的设计：

- 最佳页大小，依赖设备的K

- 保存$k—2k$个键，$k+1—2k+1$个指向子节点的指针

### B树的插入—节点分裂

#### 叶节点分裂

Step1：<u>查找算法定位目标叶节点</u>，并将新值关联

Step2：有空就插入，没空就叫”节点溢出“overflow，必须<u>分裂</u>

- 叶节点：超过$Max(N)$最多容纳N个键值对
- 非叶节点：指针超过$Max(N+1)$

Step3: 分裂——分配新节点，将一半元素从原节点传输给它，并添加它的第一个键(**拷贝一份**到父节点)和指向父节点的指针，这时候，键被提升了。执行分裂的数组下标称为而分裂点

#### 非叶节点分裂

1. 创造新节点

2. 将原节点下标为$N/2+1$的元素，**移动**到新节点

3. 分裂点的键被提升到父一级

4. 插入要插入的节点

5. 生成额外指针，指向新裂变的节点

### B树的删除—节点合并

节点合并的判定条件：（节点最大容纳N个键值对）

- 对于叶节点：两个相邻节点的键值对数量小于或等于N
- 对于非叶节点：两个相邻节点中指针的数量小于或等于N+1

*一般50%是树状结构节点占用率的阈值*

> 思考：删除和插入操作是否会导致B树节点分裂合并的频繁操作？
>
> 解决方案：
>
> 1. 按存储空间对”满“和”空“进行设置，*从更上一层的视角解决*
> 2. 为了减少分裂和合并的次数，DBMS会使用”再平衡“

### B+树索引能干什么

![](image-20240311154201920.png)

表记录的具体内容仍存储在随机文件中，一般索引中只存`rowid`

索引帮助快速查询表中的记录，充分理解B+树索引的结构，你就能充分B+树能做什么不能做什么

能做的：

- 全键值 `Where x = 123` (`depth + 1`次的固定次数)
- 键值范围 `Where 45 < x < 123` (先进行`x=45`，然后顺序读取直到`x>=123`)
- 键前缀查找 `where x LIKE J%’`